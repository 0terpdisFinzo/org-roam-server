<!doctype html>
<html>
  <head>
    <title>ORG ROAM GRAPH</title>
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <link rel="stylesheet" href="assets/select2.min.css">
    <script src="assets/jquery-3.5.0.min.js"></script>
    <script type="text/javascript" src="assets/vis-network.min.js"></script>
    <script src="assets/bootstrap.min.js"></script>
    <script src="assets/select2.min.js"></script>
    <style type="text/css">
      * { padding: 0; margin: 0; }
      html, body {
          min-height: 100% !important;
          height: 100%;
          width: 100%;
          overflow: hidden;
          position: relative;
          z-index: 0;
      }

      #global-network, #buffer-network {
          min-height: 100% !important;
          height: 100%;
          width: 100%;
          overflow: hidden;
          position: relative;
          z-index: 4;
      }

      #hoverframe{
          display: none;
          position: absolute;
          z-index: 100;
      }

      #fileframe{
          display: none;
          position: absolute;
          z-index: 100;
      }

      #iframe-button {
          display: block;
          position: absolute;
          z-index: 101;
      }

      #choose {
          position: relative;
          z-index: 5;
      }

      #dropdownfiles {
          display: none;
          position: absolute;
          width: 300px;
          z-index: 5;
      }

      #preview {
          position: absolute;
      }

    </style>

  </head>

  <body>
    <div id="dropdownfiles">
      <select class="dropdownfiles" name="files" style="width: 300px">
        <option></option>
      </select>
    </div>
    <div class="box" id="hoverframe">
      <button class="btn btn-link float-left" id="iframe-button" onclick="history.back()">Back</button>
      <iframe src="" width="500px" height="300px" id="hovernode">
      </iframe>
    </div>

    <div class="btn-group btn-group-toggle float-right" data-toggle="buttons" id="choose">
      <label class="btn btn-sm btn-primary btn-simple active" id="globalview">
        <input type="radio" name="views" checked id="global" value="global">
        <span class="d-none d-sm-block d-md-block
                     d-lg-block d-xl-block">Global View</span>
      </label>
      <label class="btn btn-sm btn-primary btn-simple" id="bufferview">
        <input type="radio" class="d-none d-sm-none" name="views"
               id="buffer" value="buffer">
        <span class="d-none d-sm-block d-md-block
                     d-lg-block d-xl-block">Buffer View</span>
      </label>
      <label class="btn btn-sm btn-primary btn-simple" id="fileview">
        <input type="radio" class="d-none d-sm-none" name="views"
               id="files" value="files">
        <span class="d-none d-sm-block d-md-block
                     d-lg-block d-xl-block">File View</span>
      </label>
    </div>
    <label class="btn btn-sm btn-primary btn-simple" id="preview">
      Enable Preview
    </label>
    <div id="global-network"></div>
    <div id="buffer-network"></div>
    <div class="fileframe" id="fileframe">
      <button class="btn btn-link float-left" id="iframe-button" onclick="history.back()">Back</button>
      <iframe src="" id="filenode"></iframe>
    </div>


    <script type="text/javascript">

      Array.prototype.max = function(compare) {
          if (this.length === 0) return null;
          if (this.length === 1) return this[0];
          compare = (compare || Math.max);
          var v = this[0];
          for (var i = 1; i < this.length; i++) {
              var ret = compare(this[i], v);
              if (ret > 0) {
                  v = this[i];
              }
          }
          return v;
      }

      $(document).ready(function () {
          var globalContainer = document.getElementById("global-network");
          var bufferContainer = document.getElementById("buffer-network");
          var hoverFrame = document.getElementById("hoverframe");
          var hoverNode = document.getElementById("hovernode");

          var transformString =
              `translateX(25px)`+
              `translateY(${($("#choose").height() + 50)/2}px)`;
          $("#fileframe").css("webkitTransform", transformString);
          $("#fileframe").css("MozTransform", transformString);
          $("#fileframe").css("msTransform", transformString);
          $("#fileframe").css("OTransform", transformString);
          $("#fileframe").css("transform", transformString);
          $("#filenode").width($(window).width() - 50);
          $("#filenode").height($(window).height() - $("#choose").height() - 50);
          window.onresize = function() {
              $("#filenode").width($(window).width() - 50);
              $("#filenode").height($(window).height() - $("#choose").height() - 50);
          }

          $("#hoverframe").hover(
              function () {
                  hoverFrame.style.display = "block";
              },
              function () {
                  hoverFrame.style.display = "none";
              });

          const graphSource = new EventSource("/graph-data");
          const bufferSource = new EventSource("/current-roam-buffer");

          var nodeDataset;
          var edgeDataset;

          var globalNetwork;
          var bufferNetwork;

          var currentNode;
          var nodes;
          var edges;
          var data;

          var clickTime = 0;

          var oldGraphEventData = "";
          var oldBufferEventData = "";

          var preview = false;

          var options = {
              nodes: {
                  shape: "dot",
              },
              interaction:{hover:true}
          };

          graphSource.onmessage = function (event) {
              if (oldGraphEventData.localeCompare(event.data) != 0) {
                  oldGraphEventData = event.data;
                  data = JSON.parse(event.data);

                  // Update Select2
                  select2Data = [];
                  for (var i = 0 ; i < data.nodes.length; i++) {
                      select2Data.push({id: data.nodes[i].id,
                                        text: data.nodes[i].label})
                  }
                  $(".dropdownfiles").select2({
                      data: select2Data,
                      placeholder: "File"
                  });
                  $('.dropdownfiles').on('select2:select', function (e) {
                      $("#filenode").attr("src", e.params.data.id.concat(".html"));
                  });

                  // Initialize Global Network
                  updateNodesAndEdges();
                  drawGlobalNetwork();
              }
          }

          bufferSource.onmessage = function (event) {
              if (oldBufferEventData.localeCompare(event.data) != 0) {
                  oldBufferEventData = event.data;
                  currentNode = event.data;
                  if (currentNode !== "") {
                      drawBufferNetwork();
                  }
              }
          }

          $("#globalview").click(function() {
              $("#preview").css("display", "block");
              $("#dropdownfiles").css("display", "none");
              $("#fileframe").css("display", "none");
              globalContainer.style.display = "block";
              bufferContainer.style.display = "none";
          });

          $("#bufferview").click(function() {
              $("#preview").css("display", "block");
              $("#dropdownfiles").css("display", "none");
              $("#fileframe").css("display", "none");
              globalContainer.style.display = "none";
              bufferContainer.style.display = "block";
              if (currentNode) {
                  drawBufferNetwork();
              }
          });
          $("#fileview").click(function() {
              globalContainer.style.display = "none";
              bufferContainer.style.display = "none";
              $("#preview").css("display", "none");
              $("#dropdownfiles").css("display", "block");
              $("#fileframe").css("display", "block");
          });
          $("#preview").click(function() {
              if (preview) {
                  preview = false;
                  $("#preview").text("Enable Preview");
              } else {
                  preview = true;
                  $("#preview").text("Disable Preview");
              }
          });

          function compareNodeValues(nodeId1, nodeId2) {
              return nodes[nodeId1].value - nodes[nodeId2].value;
          }

          function updateNodesAndEdges () {
              globalNetwork = new vis.Network(globalContainer, data, options);
              nodeDataset = new vis.DataSet(data.nodes);
              edgeDataset = new vis.DataSet(data.edges);
              nodes = nodeDataset.get({returnType:"Object"});
              edges = edgeDataset.get({returnType:"Object"});

              // Set value depending on number of connected nodes
              for (var nodeId in nodes) {
                  var connectedNodes = globalNetwork.getConnectedNodes(nodeId)
                  var degree = connectedNodes.length;
                  nodes[nodeId].value = degree;
              }

              // Group the nodes
              var keys = Object.keys(nodes);
              keys.sort(compareNodeValues);
              var group = 0;
              for (var i = 0; i < keys.length; i++) {
                  k = keys[i];
                  if (!nodes[k].group) {
                      var connectedNodes = globalNetwork.getConnectedNodes(k);
                      if (connectedNodes.length > 0) {
                          node = connectedNodes.max(compareNodeValues);
                          if (!nodes[node].group) {
                              nodes[node].group = group;
                              group += 1;
                          }
                          nodes[k].group = nodes[node].group;
                      } else {
                          nodes[k].group = group;
                          group += 1;
                      }
                  }
              }
          }

          function onNodeClick(params) {
              if ((Date.now() - clickTime) > 1000) {
                  if (params.nodes.length === 1) {
                      clickTime = Date.now();
                      var node = params.nodes[0];
                      currentNode = node;
                      window.open(globalNetwork.body.nodes[node].options.url,
                                  "_self");
                      currentNode = node;
                      // If we are in the buffer view,
                      if (bufferContainer.style.display === "block") {
                          drawBufferNetwork();
                      }
                  }
              }
          }

          function onNodeHover(params) {
              if (preview) {
                  hoverNode.src = params.node.concat(".html");
                  var pageWidth = $(window).width();
                  var pageHeight = $(window).height();
                  var hoverFrameWidth = $("#hoverframe").width();
                  var hoverFrameHeight = $("#hoverframe").height();
                  var hoverFrameX = params.event.clientX;
                  var hoverFrameY = params.event.clientY;
                  if ((hoverFrameX + hoverFrameWidth) > pageWidth) {
                      hoverFrameX = hoverFrameX - hoverFrameWidth;
                  }
                  if ((hoverFrameY + hoverFrameHeight) > pageHeight) {
                      hoverFrameY = hoverFrameY - hoverFrameHeight;
                  }

                  var transformString =
                      `translateX(${hoverFrameX}px)`+
                      `translateY(${hoverFrameY}px)`;
                  hoverFrame.style.webkitTransform = transformString;
                  hoverFrame.style.MozTransform = transformString;
                  hoverFrame.style.msTransform = transformString;
                  hoverFrame.style.OTransform = transformString;
                  hoverFrame.style.transform = transformString;
                  hoverFrame.style.display = "block";
              }
          }

          function drawBufferNetwork() {
              var connectedNodes = globalNetwork.getConnectedNodes(currentNode);
              bufferNodes = [nodes[currentNode]];
              for (var i = 0; i < connectedNodes.length; i++) {
                  if (connectedNodes[i] !== currentNode) {
                      bufferNodes.push(nodes[connectedNodes[i]]);
                  }
              }
              var bufferNodeDataset = new vis.DataSet(bufferNodes);
              bufferNetwork = new vis.Network(
                  bufferContainer,
                  {nodes:bufferNodeDataset, edges:edgeDataset},
                  options);
              bufferNetwork.on("selectNode", onNodeClick);
              bufferNetwork.on("hoverNode", onNodeHover);
          }

          function drawGlobalNetwork() {
              var updateArray = [];
              for (nodeId in nodes) {
                  if (nodes.hasOwnProperty(nodeId)) {
                      updateArray.push(nodes[nodeId]);
                  }
              }
              nodeDataset.update(updateArray);
              data = {nodes:nodeDataset, edges:edgeDataset}
              globalNetwork = new vis.Network(globalContainer, data, options);
              globalNetwork.on("selectNode", onNodeClick);
              globalNetwork.on("hoverNode", onNodeHover);
          }
      });
    </script>
  </body>
</html>
